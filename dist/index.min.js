!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],t):e.dexieRelationships=t(e.Dexie)}(this,function(e){"use strict";function t(e){return null!=e&&("string"==typeof e||"number"==typeof e||e instanceof Date||Array.isArray(e)&&e.every(t))}e="default"in e?e.default:e;var n=function(e){this.schema=e};n.prototype.getForeignKeys=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.filter(function(e){return-1!==e.indexOf("->")}).map(function(e){var t=e.split("->").map(function(e){return e.trim()}),n=t[0],r=t[1];return{index:n,targetTable:r.split(".")[0],targetIndex:r.split(".")[1]}})}),t},n.prototype.getCleanedSchema=function(){var e=this,t={};return Object.keys(this.schema).forEach(function(n){var r=e.schema[n].split(",");t[n]=r.map(function(e){return e.split("->")[0].trim()}).join(",")}),t};var r=function(r){var o=e.Promise;r.Table.prototype.with=function(e){return this.toCollection().with(e)},r.Collection.prototype.with=function(e){var n=this,i=this._ctx.table.name,a=r._allTables,f=[];return Object.keys(e).forEach(function(t){var r=e[t],o=n._ctx.table.schema.idxByName[r];if(o&&o.hasOwnProperty("foreignKey")){var u=o;f.push({column:t,index:u.foreignKey.targetIndex,tableName:u.foreignKey.targetTable,targetIndex:u.foreignKey.index,oneToOne:!0})}else{var c=r;if(!a.hasOwnProperty(c))throw new Error("Relationship table "+c+" doesn't exist.");if(!a[c].schema.hasOwnProperty("foreignKeys"))throw new Error("Relationship table "+c+" doesn't have foreign keys set.");var s=a[c].schema.foreignKeys.filter(function(e){return e.targetTable===i});s.length>0&&f.push({column:t,index:s[0].index,tableName:c,targetIndex:s[0].targetIndex})}}),this.toArray().then(function(e){var n=f.map(function(n){var r=n.tableName,o=e.map(function(e){return e[n.targetIndex]}).filter(t);return a[r].where(n.index).anyOf(o)}),r=n.map(function(e){return e.toArray()});return o.all(r).then(function(t){f.forEach(function(n,r){var o=n.tableName,a=t[r],f=n.targetIndex,u=n.index,c=n.column,s={};a.forEach(function(e){var t=e[u];n.oneToOne?s[t]=e:(s[t]=s[t]||[]).push(e)}),e.forEach(function(e){var t=e[f],r=void 0!==s[t]?s[t]:n.oneToOne?null:[];if(!r)throw new Error("Could not lookup foreign key where "+o+"."+u+" == "+i+"."+c+". The content of the failing key was: "+JSON.stringify(t)+".");Object.defineProperty(e,c,{value:r,enumerable:!1,configurable:!0,writable:!0})})})}).then(function(){return e})})},r.Version.prototype._parseStoresSpec=e.override(r.Version.prototype._parseStoresSpec,function(e){return function(t,r){var o=new n(t),i=o.getForeignKeys(),a=e.call(this,o.getCleanedSchema(),r);return Object.keys(r).forEach(function(e){i.hasOwnProperty(e)&&(r[e].foreignKeys=i[e],i[e].forEach(function(t){r[e].idxByName[t.index].foreignKey=t}))}),a}})};return r.default=r,r});
//# sourceMappingURL=index.min.js.map
